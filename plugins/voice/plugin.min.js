tinymce.PluginManager.add("voice", function (editor, url) {
    // 存储token供iframe使用
    let cachedToken = null;
    
    const openDialog = () => {
        const root = window.RX_TINYMCE_ROOT || '';
        // 获取token，支持从全局变量或localStorage获取
        cachedToken = localStorage.getItem('token') || '';
        
        const dialogUrl = `${root}/plugins/voice/voice-dialog/index.html?root=${encodeURIComponent(root)}`;
        
        return editor.windowManager.openUrl({
            title: "插入音频",
            url: dialogUrl,
            width: 800,
            height: 700,
        });
    };

    // 注册一个工具栏按钮名称
    editor.ui.registry.addButton("voice", {
        icon: "voice",
        tooltip: "插入音频",
        // text: '插入音频',
        onAction: function () {
            openDialog();
        },
    });

    // 监听来自对话框的消息
    window.addEventListener("message", (e) => {
        // 请求token
        if (e.data?.source === "tinymce-voice" && e.data.type === "request-token") {
            e.source.postMessage(
                {
                    source: "tinymce-voice-parent",
                    type: "token-response",
                    token: cachedToken
                },
                "*"
            );
        }
        
        // 插入音频
        if (e.data?.source === "tinymce-voice" && e.data.type === "insert") {
            const { name, author, user_id, src } = e.data.payload;
            // 插入音频HTML，使用 w-audio 和 e-audio 类名
            const content = `name:${name || ''};author:${author || ''};user_id:${user_id || ''};src:${src || ''}`;
            editor.insertContent(`<pre class="w-audio e-audio">${content}</pre>`);
            editor.windowManager.close();
        }

        // 关闭对话框
        if (e.data?.source === "tinymce-voice" && e.data.type === "close") {
            editor.windowManager.close();
        }
    });

    // 注册一个菜单项名称 menu/menubar
    // editor.ui.registry.addMenuItem("voice", {
    //     text: "插入音频",
    //     onAction: function () {
    //         openDialog();
    //     },
    // });

    return {
        getMetadata: function () {
            return {
                //插件名和链接会显示在“帮助”→“插件”→“已安装的插件”中
                name: "voice", //插件名称
                url: "https://github.com/JX3BOX", //作者网址
            };
        },
    };
});
